<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Escanear Art√≠culos - Almac√©n Dulces</title>

  <!-- Fuente y librer√≠a Excel -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body{font-family:'Poppins',sans-serif;background:linear-gradient(to right,#00416A,#E4E5E6);color:white;padding:20px;margin:0;min-height:100vh;box-sizing:border-box}
    h1{text-align:center;margin-bottom:20px}
    .fila{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .folio-box{background:white;color:#00416A;font-weight:bold;padding:6px 12px;border-radius:8px;display:inline-block}
    input,button,select{font-family:inherit;padding:10px;font-size:16px;border-radius:6px;border:none}
    input{width:100%;max-width:320px}
    .acciones button{width:auto}
    .boton{background:#0c6cbd;color:white;font-weight:bold;cursor:pointer;transition:background .3s}
    .boton:hover{background:#084f92}
    .sec{margin-top:14px}
    .contenedor-tabla{background:white;color:black;border-radius:8px;overflow-x:auto;margin-top:14px}
    table{width:100%;border-collapse:collapse;min-width:760px}
    th,td{padding:10px;border:1px solid #ccc;text-align:center}
    th{background-color:#00416A;color:white;position:sticky;top:0}
    td button{padding:6px 10px;margin:2px;border:none;border-radius:6px;font-size:16px;cursor:pointer}
    .resumen{background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);border-radius:10px;padding:10px;display:flex;gap:16px;flex-wrap:wrap}
    #modal-folios{display:none;position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:999;justify-content:center;align-items:center}
    #modal-folios>div{background:white;color:black;padding:20px;border-radius:10px;max-width:90%;width:400px;box-shadow:0 0 10px rgba(0,0,0,.4)}
    @media(max-width:600px){
      h1{font-size:20px}
      input,button,select{font-size:18px;padding:14px}
      th,td{font-size:14px;padding:8px}
      td button{font-size:18px;padding:8px 12px}
      #modal-folios>div{width:95%}
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs,
      query, where
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // ===== Config =====
    const DEC_CANTIDAD = 3; // cantidades con 3 decimales
    const DEC_PRECIO   = 2; // precios con 2 decimales
    const DEC_IMPORTE  = 2;

    const firebaseConfig = {
      apiKey: "AIzaSyCK5nb6u2CGRJ8AB1aPlRn54b97bdeAFeM",
      authDomain: "inventariopv-643f1.firebaseapp.com",
      projectId: "inventariopv-643f1",
      storageBucket: "inventariopv-643f1.appspot.com",
      messagingSenderId: "96242533231",
      appId: "1:96242533231:web:aae75a18fbaf9840529e9a"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Helpers
    const roundTo = (num, dec) => Math.round((Number(num) + Number.EPSILON) * 10**dec) / 10**dec;
    const fmt     = (num, dec) => Number(num ?? 0).toFixed(dec);

    // DOM
    const inputClave     = document.getElementById("palabraClave");
    const inputCodigo    = document.getElementById("codigo");
    const inputCantidad  = document.getElementById("cantidad");
    const btnAgregar     = document.getElementById("agregar");
    const exportarBtn    = document.getElementById("exportar");
    const exportarActBtn = document.getElementById("exportar-actual");
    const limpiarBtn     = document.getElementById("limpiar");
    const limpiarCacheBtn= document.getElementById("limpiar-cache");
    const guardarBtn     = document.getElementById("guardar");
    const folioSpan      = document.getElementById("folio");
    const tabla          = document.getElementById("tabla-productos");
    const tRenglones     = document.getElementById("tRenglones");
    const tCantidad      = document.getElementById("tCantidad");
    const tImporte       = document.getElementById("tImporte");

    const modal  = document.getElementById("modal-folios");
    const select = document.getElementById("select-folio");

    // Estado
    let articulosEscaneados = JSON.parse(localStorage.getItem("articulosEscaneadosDulces")) || [];
    let folio = localStorage.getItem("folioInventarioDulces") || generarFolio();
    let palabraClaveGuardada = localStorage.getItem("claveInventarioDulces") || "";
    let cacheProductos = JSON.parse(localStorage.getItem("cacheProductosDulces") || "{}"); // { codigo: {descripcion,codigo,precio} }

    folioSpan.textContent = folio;
    inputClave.value = palabraClaveGuardada;
    actualizarTabla();

    function guardarCache() {
      localStorage.setItem("cacheProductosDulces", JSON.stringify(cacheProductos));
    }

    function generarFolio() {
      const fecha = new Date();
      let base = `INVT-DULCES-${fecha.toISOString().slice(0,10).replace(/-/g, '')}-${fecha.getHours()}${String(fecha.getMinutes()).padStart(2,'0')}${String(fecha.getSeconds()).padStart(2,'0')}`;
      const clave = inputClave?.value.trim();
      if (clave) base += `-${clave.replace(/\s+/g, "_").toUpperCase()}`;
      return base;
    }

    inputClave.addEventListener("input", () => {
      localStorage.setItem("claveInventarioDulces", inputClave.value.trim());
    });

    // B√∫squeda con mini-cache
    async function buscarProductoPorCodigo(codigo) {
      if (cacheProductos[codigo]) return cacheProductos[codigo];

      const q = query(collection(db, "productos"), where("Codigo Barra", "==", codigo));
      const snap = await getDocs(q);
      if (snap.empty) throw new Error("Producto no encontrado");

      const data = snap.docs[0].data();
      const prod = {
        descripcion: data.Concepto || "Sin descripci√≥n",
        codigo: data["Codigo Barra"],
        precio: roundTo(parseFloat(data["Precio Publico"] || 0), DEC_PRECIO)
      };
      cacheProductos[codigo] = prod;
      guardarCache();
      return prod;
    }

    // Flujo de foco: Enter en c√≥digo -> cantidad
    inputCodigo.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        inputCantidad.focus();
        inputCantidad.select();
      }
    });

    // Enter en cantidad -> agrega
    inputCantidad.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        agregarArticuloDesdeInputs();
      }
    });

    btnAgregar.addEventListener("click", agregarArticuloDesdeInputs);

    async function agregarArticuloDesdeInputs() {
      const codigo = (inputCodigo.value || "").trim();
      const cantidadRaw = (inputCantidad.value || "").trim();
      const cantidad = roundTo(parseFloat(cantidadRaw), DEC_CANTIDAD);

      if (!codigo || isNaN(cantidad) || cantidad <= 0) {
        alert("C√≥digo o cantidad inv√°lida.");
        (!codigo ? inputCodigo : inputCantidad).focus();
        return;
      }

      try {
        const p = await buscarProductoPorCodigo(codigo);
        const idx = articulosEscaneados.findIndex(x => x.codigo === p.codigo);

        if (idx !== -1) {
          // Sumar cantidad si ya existe
          articulosEscaneados[idx].cantidad = roundTo(Number(articulosEscaneados[idx].cantidad) + cantidad, DEC_CANTIDAD);
          articulosEscaneados[idx].timestamp = new Date().toISOString();
        } else {
          articulosEscaneados.push({
            descripcion: p.descripcion,
            codigo: p.codigo,
            precio: p.precio,
            cantidad: cantidad,
            timestamp: new Date().toISOString()
          });
        }

        actualizarTabla();

        // Reset para siguiente escaneo
        inputCodigo.value = "";
        inputCantidad.value = "1.000";
        inputCodigo.focus();
      } catch (err) {
        console.error(err);
        alert("Producto no encontrado.");
        inputCodigo.focus();
        inputCodigo.select();
      }
    }

    function actualizarTabla() {
      tabla.innerHTML = "";
      let sumaCant = 0;
      let sumaImp  = 0;

      articulosEscaneados.forEach((p, index) => {
        const importe = roundTo((Number(p.cantidad) || 0) * (Number(p.precio) || 0), DEC_IMPORTE);
        sumaCant += Number(p.cantidad) || 0;
        sumaImp  += importe;

        const fila = document.createElement("tr");
        fila.innerHTML = `
          <td>${index + 1}</td>
          <td>${p.descripcion}</td>
          <td>${p.codigo}</td>
          <td>${fmt(p.cantidad, DEC_CANTIDAD)}</td>
          <td>$${fmt(p.precio, DEC_PRECIO)}</td>
          <td>$${fmt(importe, DEC_IMPORTE)}</td>
          <td>${(p.timestamp || "").slice(0, 19).replace('T',' ')}</td>
          <td>
            <button onclick="editarCantidad(${index})">‚úèÔ∏è</button>
            <button onclick="eliminarArticulo(${index})">üóëÔ∏è</button>
          </td>
        `;
        tabla.appendChild(fila);
      });

      // Totales
      tRenglones.textContent = articulosEscaneados.length;
      tCantidad.textContent  = fmt(sumaCant, DEC_CANTIDAD);
      tImporte.textContent   = fmt(sumaImp, DEC_IMPORTE);

      // Persistencia local
      localStorage.setItem("articulosEscaneadosDulces", JSON.stringify(articulosEscaneados));
      localStorage.setItem("folioInventarioDulces", folio);
    }

    guardarBtn.addEventListener("click", async () => {
      if (articulosEscaneados.length === 0) {
        alert("No hay art√≠culos para guardar.");
        return;
      }

      folio = generarFolio();
      folioSpan.textContent = folio;

      const grupo = {
        folio,
        fecha: new Date().toISOString(),
        articulos: articulosEscaneados,
        totalArticulos: articulosEscaneados.length,
        sumaCantidades: articulosEscaneados.reduce((a,b)=>a+(Number(b.cantidad)||0),0),
        sumaImporte:   roundTo(articulosEscaneados.reduce((a,b)=>a+((Number(b.cantidad)||0)*(Number(b.precio)||0)),0), DEC_IMPORTE),
        palabraClave: (inputClave.value||"").trim() || null
      };

      try {
        await addDoc(collection(db, "almacenes/Almacen_Dulces/inventarios"), grupo);
        alert(`‚úÖ Inventario guardado con folio: ${folio}`);

        articulosEscaneados = [];
        localStorage.removeItem("articulosEscaneadosDulces");
        localStorage.removeItem("folioInventarioDulces");
        // NO borramos la clave por si sigues con el mismo contexto
        actualizarTabla();
        folio = generarFolio();
        folioSpan.textContent = folio;
        inputCodigo.value = "";
        inputCantidad.value = "1.000";
      } catch (e) {
        console.error("Error al guardar:", e);
        alert("‚ùå Error al guardar el inventario.");
      }
    });

    // Exportar Excel de la lista actual (sin guardar)
    exportarActBtn.addEventListener("click", () => {
      if (!articulosEscaneados.length) return alert("No hay art√≠culos en la lista actual.");
      exportarAExcel(articulosEscaneados, folio);
    });

    // Exportar Excel por folio guardado
    exportarBtn.addEventListener("click", async () => {
      modal.style.display = "flex";
      select.innerHTML = `<option value="">Cargando folios...</option>`;

      const snapshot = await getDocs(collection(db, "almacenes/Almacen_Dulces/inventarios"));
      select.innerHTML = `<option value="">Selecciona un folio</option>`;
      window.foliosMap = {};

      snapshot.forEach(doc => {
        const data = doc.data();
        if (data.folio) {
          window.foliosMap[data.folio] = data;
          const option = document.createElement("option");
          option.value = data.folio;
          option.textContent = data.folio;
          select.appendChild(option);
        }
      });
    });

    document.getElementById("descargar-seleccionado").addEventListener("click", () => {
      const folioSel = select.value;
      const grupo = window.foliosMap?.[folioSel];
      if (!folioSel || !grupo) return alert("Selecciona un folio v√°lido.");
      exportarAExcel(grupo.articulos || [], grupo.folio);
      modal.style.display = "none";
    });

    function exportarAExcel(lista, folioParaNombre) {
      const encabezados = [["#", "Descripci√≥n", "C√≥digo", "Cantidad", "Precio", "Importe", "Fecha", "Folio"]];
      const datos = lista.map((p, i) => {
        const importe = roundTo((Number(p.cantidad)||0)*(Number(p.precio)||0), DEC_IMPORTE);
        return [
          i + 1,
          p.descripcion,
          p.codigo,
          fmt(p.cantidad ?? 0, DEC_CANTIDAD),
          fmt(p.precio ?? 0, DEC_PRECIO),
          fmt(importe, DEC_IMPORTE),
          (p.timestamp || "").slice(0, 19).replace('T',' '),
          folioParaNombre
        ];
      });

      // Totales al final
      const sumaCant = lista.reduce((a,b)=>a+(Number(b.cantidad)||0),0);
      const sumaImp  = roundTo(lista.reduce((a,b)=>a+((Number(b.cantidad)||0)*(Number(b.precio)||0)),0), DEC_IMPORTE);
      datos.push([]);
      datos.push(["", "TOTALES", "", fmt(sumaCant, DEC_CANTIDAD), "", fmt(sumaImp, DEC_IMPORTE), "", folioParaNombre]);

      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.aoa_to_sheet(encabezados.concat(datos));
      XLSX.utils.book_append_sheet(wb, ws, "Inventario");
      XLSX.writeFile(wb, `Inventario_${folioParaNombre}.xlsx`);
    }

    limpiarBtn.addEventListener("click", () => {
      if (!articulosEscaneados.length) return;
      if (confirm("¬øLimpiar la lista actual?")) {
        articulosEscaneados = [];
        actualizarTabla();
      }
    });

    limpiarCacheBtn.addEventListener("click", () => {
      if (confirm("¬øBorrar la cach√© local de productos?")) {
        cacheProductos = {};
        guardarCache();
        alert("Cach√© borrada.");
      }
    });

    // Exponer funciones para botones de la tabla
    window.editarCantidad = function(index) {
      const actual = articulosEscaneados[index].cantidad;
      const nuevaStr = prompt("Nueva cantidad (admite 3 decimales):", fmt(actual, DEC_CANTIDAD));
      const nueva = roundTo(parseFloat(nuevaStr), DEC_CANTIDAD);
      if (!isNaN(nueva) && nueva > 0) {
        articulosEscaneados[index].cantidad = nueva;
        articulosEscaneados[index].timestamp = new Date().toISOString();
        actualizarTabla();
      } else {
        alert("Cantidad inv√°lida.");
      }
    };

    window.eliminarArticulo = function(index) {
      if (confirm("¬øEliminar este art√≠culo?")) {
        articulosEscaneados.splice(index, 1);
        actualizarTabla();
      }
    };
  </script>
</head>
<body>
  <h1>Escanear Art√≠culos - Almac√©n Dulces</h1>

  <div class="fila">
    <div>Folio actual: <span class="folio-box" id="folio"></span></div>
  </div>

  <div class="fila sec">
    <label for="palabraClave" style="min-width:140px">Palabra clave:</label>
    <input type="text" id="palabraClave" placeholder="Ej. BODEGA, URGENTE, PROV">
  </div>

  <div class="fila sec">
    <input type="text" id="codigo" placeholder="Escanea o escribe el c√≥digo de barras...">
    <input type="number" id="cantidad" placeholder="Cantidad" value="1.000" step="0.001" min="0.001">
    <button class="boton" id="agregar">‚ûï Agregar</button>
  </div>

  <div class="fila acciones sec">
    <button class="boton" id="guardar">üíæ Guardar Inventario</button>
    <button class="boton" id="exportar-actual">üì• Descargar Excel (actual)</button>
    <button class="boton" id="exportar">üì• Descargar Excel (folios guardados)</button>
    <button class="boton" id="limpiar">üßπ Limpiar lista</button>
    <button class="boton" id="limpiar-cache" title="Borra la cach√© local de productos">üóÇÔ∏è Limpiar cach√©</button>
  </div>

  <div class="contenedor-tabla">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Descripci√≥n</th>
          <th>C√≥digo</th>
          <th>Cantidad</th>
          <th>Precio</th>
          <th>Importe</th>
          <th>Fecha</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-productos"></tbody>
    </table>
  </div>

  <div class="resumen sec">
    <div><b>Renglones:</b> <span id="tRenglones">0</span></div>
    <div><b>Suma cantidades:</b> <span id="tCantidad">0.000</span></div>
    <div><b>Importe total:</b> $<span id="tImporte">0.00</span></div>
  </div>

  <div id="modal-folios">
    <div>
      <h3>Selecciona un folio para descargar</h3>
      <select id="select-folio" style="width:100%"></select>
      <div style="display:flex;gap:10px;margin-top:10px;flex-wrap:wrap">
        <button id="descargar-seleccionado" class="boton">üì• Descargar Excel</button>
        <button onclick="document.getElementById('modal-folios').style.display='none'" class="boton" style="background:#ccc;color:#000;">Cancelar</button>
      </div>
    </div>
  </div>
</body>
</html>
